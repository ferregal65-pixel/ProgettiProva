<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spesa Pro v5.3 Mobile</title>
    
    <style>
        :root {
            --primary: #2ecc71;
            --primary-dark: #27ae60;
            --accent: #f1c40f;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
        }

        /* Reset e prevenzione zoom su iPhone */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        #stats-container {
            background: #f0fff4;
            padding: 10px;
            border-radius: 12px;
            margin-top: 5px;
        }

        #total-cost { font-size: 1.1rem; color: var(--primary-dark); font-weight: 800; }

        /* Form di inserimento ottimizzato per dita */
        .input-card {
            padding: 12px;
            background: #fff;
            border-bottom: 2px solid #eee;
        }

        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }

        input, select {
            border: 2px solid #dfe6e9;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px; /* Evita zoom automatico su iOS */
            outline: none;
            background: #fff;
            width: 100%;
        }

        #itemQty { width: 75px; text-align: center; font-weight: bold; }
        #itemUnit { width: 100px; }
        #itemPrice { width: 110px; }
        
        #addBtn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 800;
            width: 100%;
            font-size: 1.1rem;
            box-shadow: 0 4px 0 var(--primary-dark);
        }

        #addBtn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--primary-dark); }

        /* Lista prodotti */
        #shoppingList {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
            background: #fdfdfd;
        }

        li {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #f1f2f6;
            gap: 10px;
        }

        .qty-badge {
            background: #e8f4fd;
            color: #0984e3;
            padding: 8px 4px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 800;
            min-width: 85px;
            text-align: center;
        }

        .item-info { flex: 1; min-width: 0; }
        .item-text { font-size: 1.05rem; font-weight: 600; display: block; margin-bottom: 2px; }
        .item-sub { font-size: 0.8rem; color: #636e72; }

        .price-container { text-align: right; min-width: 80px; }
        .total-price { font-size: 1rem; color: #27ae60; font-weight: 800; }

        .completed { background: #f9f9f9; opacity: 0.5; }
        .completed .item-text { text-decoration: line-through; }

        .actions { display: flex; gap: 5px; }
        .btn-icon { background: #f1f2f6; border: none; padding: 8px; border-radius: 8px; font-size: 1.2rem; }

        footer { padding: 10px; background: white; }
        .footer-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; background: #636e72; color: white; font-weight: bold; }

        /* Modal */
        #historyModal {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 90%; max-height: 80vh; overflow-y: auto; }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <div id="stats-container">
                <div id="total-cost">Caricamento...</div>
                <div id="stats" style="font-size: 0.8rem; color: #666;"></div>
            </div>
        </header>

        <div class="input-card">
            <div class="input-row">
                <input type="text" id="itemQty" inputmode="decimal" placeholder="Q.t√†">
                <select id="itemUnit">
                    <option value="pz">üî¢ Pz</option>
                    <option value="kg">‚öñÔ∏è Kg</option>
                    <option value="g">‚öñÔ∏è g</option>
                    <option value="lt">üíß Lt</option>
                    <option value="conf">üì¶ Conf</option>
                </select>
                <select id="itemCategory" style="flex:1">
                    <option value="üçé Ortofrutta">üçé Ortofrutta</option>
                    <option value="üçû Forno">üçû Forno</option>
                    <option value="ü•© Macelleria">ü•© Macelleria</option>
                    <option value="ü•õ Freschi">ü•õ Freschi</option>
                    <option value="üçù Dispensa">üçù Dispensa</option>
                    <option value="ü•§ Bevande">ü•§ Bevande</option>
                    <option value="üßº Casa/Igiene">üßº Casa/Igiene</option>
                    <option value="üì¶ Altro">üì¶ Altro</option>
                </select>
            </div>
            <div class="input-row">
                <input type="text" id="itemInput" placeholder="Nome prodotto..." list="historyData">
                <button class="btn-icon" onclick="toggleHistoryModal()">‚öôÔ∏è</button>
                <input type="text" id="itemPrice" placeholder="Prezzo ‚Ç¨" inputmode="decimal">
            </div>
            <button id="addBtn" type="button" onclick="addItem()">AGGIUNGI IN LISTA</button>
        </div>

        <ul id="shoppingList"></ul>

        <footer>
            <button class="footer-btn" onclick="clearList()">Svuota Lista</button>
        </footer>
    </div>

    <div id="historyModal">
        <div class="modal-content">
            <h3>Cronologia</h3>
            <div id="historyList"></div>
            <button onclick="toggleHistoryModal()" style="margin-top:20px; width:100%; padding:15px; border-radius:10px; border:none; background:#eee;">Chiudi</button>
        </div>
    </div>

    <datalist id="historyData"></datalist>

    <script>
        let editMode = false;
        let originalNameBeforeEdit = "";
        const unitEmojis = { 'pz': 'üî¢', 'conf': 'üì¶', 'kg': '‚öñÔ∏è', 'g': '‚öñÔ∏è', 'lt': 'üíß' };

        // Parsing robusto del numero (gestisce virgola e punto)
        function parseNum(val) {
            if (!val) return null;
            let n = parseFloat(val.toString().replace(',', '.'));
            return isNaN(n) ? null : n;
        }

        function formatEuro(n) {
            return n.toFixed(2).replace('.', ',');
        }

        function addItem() {
            const nameEl = document.getElementById('itemInput');
            const qtyEl = document.getElementById('itemQty');
            const unitEl = document.getElementById('itemUnit');
            const priceEl = document.getElementById('itemPrice');
            const catEl = document.getElementById('itemCategory');

            let nome = nameEl.value.trim();
            if (!nome) { alert("Inserisci il nome del prodotto"); return; }
            
            nome = nome.charAt(0).toUpperCase() + nome.slice(1);

            let items = JSON.parse(localStorage.getItem('spesa_v5')) || [];

            if (editMode) {
                items = items.filter(i => i.nome !== originalNameBeforeEdit);
                editMode = false;
                document.getElementById('addBtn').textContent = "AGGIUNGI IN LISTA";
                document.getElementById('addBtn').style.backgroundColor = "var(--primary)";
            }

            const rawQty = qtyEl.value.trim();
            const qtaNum = parseNum(rawQty) !== null ? parseNum(rawQty) : 1;
            const prezzoUnit = parseNum(priceEl.value) || 0;

            // Calcolo totale
            let totale = qtaNum * prezzoUnit;
            if (unitEl.value === 'g') totale = (qtaNum / 1000) * prezzoUnit;

            items.push({
                nome: nome,
                qta: qtaNum,
                qtaText: rawQty || "1",
                unita: unitEl.value,
                prezzo: prezzoUnit,
                categoria: catEl.value,
                totale: totale,
                preso: false
            });

            localStorage.setItem('spesa_v5', JSON.stringify(items));
            
            // Salvataggio cronologia
            let history = JSON.parse(localStorage.getItem('cronologia_v5')) || [];
            if(!history.includes(nome)) {
                history.push(nome);
                localStorage.setItem('cronologia_v5', JSON.stringify(history));
            }

            // Reset campi
            nameEl.value = ""; qtyEl.value = ""; priceEl.value = "";
            refreshUI();
        }

        function refreshUI() {
            const listEl = document.getElementById('shoppingList');
            const items = JSON.parse(localStorage.getItem('spesa_v5')) || [];
            listEl.innerHTML = "";

            let totGenerale = 0;
            let totPreso = 0;

            items.sort((a,b) => a.categoria.localeCompare(b.categoria)).forEach(item => {
                totGenerale += item.totale;
                if(item.preso) totPreso += item.totale;

                const li = document.createElement('li');
                if(item.preso) li.className = 'completed';

                li.innerHTML = `
                    <div class="qty-badge">${unitEmojis[item.unita]} ${item.qtaText.replace('.',',')} ${item.unita}</div>
                    <div class="item-info" onclick="togglePreso('${item.nome.replace(/'/g, "\\'")}')">
                        <span class="item-text">${item.nome}</span>
                        <span class="item-sub">${item.categoria} ‚Ä¢ ‚Ç¨ ${formatEuro(item.prezzo)}${item.unita==='g'?'/kg':''}</span>
                    </div>
                    <div class="price-container">
                        <span class="total-price">‚Ç¨ ${formatEuro(item.totale)}</span>
                    </div>
                    <div class="actions">
                        <button class="btn-icon" onclick="prepareEdit('${item.nome.replace(/'/g, "\\'")}')">‚úçÔ∏è</button>
                    </div>
                `;
                listEl.appendChild(li);
            });

            document.getElementById('total-cost').innerHTML = `Speso: ‚Ç¨ ${formatEuro(totPreso)} / <span style="color:#7f8c8d">Tot: ‚Ç¨ ${formatEuro(totGenerale)}</span>`;
            document.getElementById('stats').textContent = `Articoli in lista: ${items.length}`;
            updateDatalist();
        }

        function togglePreso(nome) {
            let items = JSON.parse(localStorage.getItem('spesa_v5'));
            let i = items.findIndex(x => x.nome === nome);
            items[i].preso = !items[i].preso;
            localStorage.setItem('spesa_v5', JSON.stringify(items));
            refreshUI();
        }

        function prepareEdit(nome) {
            let items = JSON.parse(localStorage.getItem('spesa_v5'));
            let item = items.find(x => x.nome === nome);
            
            document.getElementById('itemInput').value = item.nome;
            document.getElementById('itemQty').value = item.qtaText;
            document.getElementById('itemUnit').value = item.unita;
            document.getElementById('itemPrice').value = item.prezzo || "";
            document.getElementById('itemCategory').value = item.categoria;

            editMode = true;
            originalNameBeforeEdit = nome;
            document.getElementById('addBtn').textContent = "AGGIORNA PRODOTTO";
            document.getElementById('addBtn').style.backgroundColor = "var(--accent)";
            window.scrollTo(0,0);
        }

        function clearList() {
            if(confirm("Vuoi cancellare tutta la lista?")) {
                localStorage.removeItem('spesa_v5');
                refreshUI();
            }
        }

        function updateDatalist() {
            const h = JSON.parse(localStorage.getItem('cronologia_v5')) || [];
            document.getElementById('historyData').innerHTML = h.map(x => `<option value="${x}">`).join('');
        }

        function toggleHistoryModal() {
            const m = document.getElementById('historyModal');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
            if(m.style.display === 'flex') {
                const h = JSON.parse(localStorage.getItem('cronologia_v5')) || [];
                document.getElementById('historyList').innerHTML = h.map(x => `
                    <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                        ${x} <button onclick="deleteHistory('${x.replace(/'/g, "\\'")}')">‚ùå</button>
                    </div>
                `).join('');
            }
        }

        function deleteHistory(nome) {
            let h = JSON.parse(localStorage.getItem('cronologia_v5'));
            h = h.filter(x => x !== nome);
            localStorage.setItem('cronologia_v5', JSON.stringify(h));
            toggleHistoryModal(); toggleHistoryModal();
        }

        // Gestione tasto Invio
        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addItem();
                document.activeElement.blur(); // Chiude tastiera mobile
            }
        });

        window.onload = refreshUI;
    </script>
</body>
</html>
