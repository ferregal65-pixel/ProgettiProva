<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spesa Pro v5.1</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">

    <style>
        :root {
            --primary: #4CAF50;
            --primary-dark: #388E3C;
            --accent: #ff9800;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --input-border: #dcdde1;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            padding: 10px;
            margin: 0;
            height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background: var(--card-bg);
            width: 100%;
            max-width: 550px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-radius: 24px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
            max-height: 98vh;
        }

        header { text-align: center; margin-bottom: 15px; }
        h1 { margin: 0; font-size: 1.5rem; font-weight: 800; }

        #stats-container {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 15px;
            margin-top: 10px;
        }

        #stats { font-size: 0.8rem; color: #666; font-weight: 700; text-transform: uppercase; }
        #total-cost { font-size: 1rem; color: var(--primary-dark); font-weight: 800; margin-top: 2px; }

        .input-card {
            background: #f1f2f6;
            padding: 15px;
            border-radius: 18px;
            margin-bottom: 15px;
        }

        .input-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }

        input, select {
            border: 1.5px solid var(--input-border);
            border-radius: 12px;
            padding: 10px;
            font-size: 14px;
            outline: none;
            background: white;
        }

        #itemQty { 
            width: 70px; 
            font-weight: bold; 
            text-align: center;
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #itemPrice { width: 100px; }
        #itemCategory { flex: 1; }

        #addBtn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            transition: 0.2s;
        }

        #addBtn.edit-mode { background-color: var(--accent); }

        #shoppingList {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }

        li {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f1f2f6;
            gap: 10px;
        }

        .qty-badge {
            background: #e1f5fe;
            color: #0288d1;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 85px;
            text-align: center;
        }

        .item-info { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .item-text { font-size: 1rem; cursor: pointer; font-weight: 500; }
        .item-sub { font-size: 0.75rem; color: #95a5a6; }

        .price-container { text-align: right; min-width: 90px; }
        .total-price { font-size: 1rem; color: #27ae60; font-weight: 800; display: block; }

        .completed { opacity: 0.4; background: #fdfdfd; }
        .completed .item-text { text-decoration: line-through; }

        .actions { display: flex; gap: 3px; }
        .edit-btn, .delete-btn, .history-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 4px; }

        #historyModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 20px;
            width: 85%;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        footer { margin-top: 15px; }
        .footer-btn { width: 100%; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; background: #2f3542; color: white; }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>üõí Spesa Pro v5.1</h1>
            <div id="stats-container">
                <div id="stats">Articoli: 0</div>
                <div id="total-cost">Speso: ‚Ç¨ 0,00 / Tot: ‚Ç¨ 0,00</div>
            </div>
        </header>

        <div class="input-card">
            <div class="input-row">
                <input type="text" id="itemQty" inputmode="decimal" placeholder="Q.t√†">
                <select id="itemUnit">
                    <option value="pz">üî¢ Pz</option>
                    <option value="kg">‚öñÔ∏è Kg</option>
                    <option value="g">‚öñÔ∏è g</option>
                    <option value="lt">üíß Lt</option>
                    <option value="conf">üì¶ Conf</option>
                </select>
                <select id="itemCategory">
                    <option value="üçé Frutta">üçé Frutta</option>
                    <option value="ü•¶ Verdura">ü•¶ Verdura</option>
                    <option value="üçû Pane e Forno">üçû Pane e Forno</option>
                    <option value="ü•õ Latticini e Uova">ü•õ Latticini e Uova</option>
                    <option value="ü•© Carne">ü•© Carne</option>
                    <option value="üêü Pesce">üêü Pesce</option>
                    <option value="üçù Pasta, Riso e Farine">üçù Pasta, Riso e Farine</option>
                    <option value="ü•´ Sughi e Scatolame">ü•´ Sughi e Scatolame</option>
                    <option value="üßÇ Olio e Spezie">üßÇ Olio e Spezie</option>
                    <option value="üç™ Colazione e Dolci">üç™ Colazione e Dolci</option>
                    <option value="ü•§ Bevande e Acqua">ü•§ Bevande e Acqua</option>
                    <option value="üç∫ Birra e Vino">üç∫ Birra e Vino</option>
                    <option value="üßä Surgelati">üßä Surgelati</option>
                    <option value="ü•™ Salumi e Formaggi">ü•™ Salumi e Formaggi</option>
                    <option value="üßº Pulizia Casa">üßº Pulizia Casa</option>
                    <option value="üß¥ Igiene Persona">üß¥ Igiene Persona</option>
                    <option value="üë∂ Infanzia">üë∂ Infanzia</option>
                    <option value="üêæ Animali">üêæ Animali</option>
                    <option value="üîã Casalinghi e Varie">üîã Casalinghi e Varie</option>
                    <option value="üì¶ Altro">üì¶ Altro</option>
                </select>
            </div>
            <div class="input-row">
                <input type="text" id="itemInput" placeholder="Cosa serve?" list="historyData" style="flex:1">
                <button class="history-btn" onclick="toggleHistoryModal()" title="Gestisci Cronologia">‚öôÔ∏è</button>
                <input type="text" id="itemPrice" placeholder="‚Ç¨/Kg o ‚Ç¨/Pz" inputmode="decimal">
            </div>
            <button id="addBtn" onclick="addItem()">Aggiungi in Lista</button>
        </div>

        <ul id="shoppingList"></ul>

        <footer>
            <button class="footer-btn" onclick="clearList()">Svuota Lista</button>
        </footer>
    </div>

    <div id="historyModal">
        <div class="modal-content">
            <h3>Gestione Cronologia</h3>
            <div id="historyList"></div>
            <button onclick="toggleHistoryModal()" style="margin-top:15px; width:100%; padding:10px; border-radius:10px; border:none; background:#eee;">Chiudi</button>
        </div>
    </div>

    <datalist id="historyData"></datalist>

    <script>
        let editMode = false;
        let originalNameBeforeEdit = "";
        const unitEmojis = { 'pz': 'üî¢', 'conf': 'üì¶', 'kg': '‚öñÔ∏è', 'g': '‚öñÔ∏è', 'lt': 'üíß' };

        function formatDisplay(val) {
            return val ? val.toString().replace('.', ',') : "0";
        }

        function parseToFloat(val) {
            if(!val) return null;
            return parseFloat(val.toString().replace(',', '.'));
        }

        function addItem() {
            const input = document.getElementById('itemInput'), 
                  qty = document.getElementById('itemQty'),
                  unit = document.getElementById('itemUnit'), 
                  cat = document.getElementById('itemCategory'),
                  price = document.getElementById('itemPrice');

            let text = input.value.trim();
            if (!text) return;
            text = text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();

            let items = JSON.parse(localStorage.getItem('spesa')) || [];
            if (editMode) {
                items = items.filter(i => i.nome !== originalNameBeforeEdit);
                editMode = false;
                document.getElementById('addBtn').textContent = "Aggiungi in Lista";
                document.getElementById('addBtn').classList.remove('edit-mode');
            }

            const qtyRaw = qty.value.trim();
            const qtyNum = parseToFloat(qtyRaw) !== null ? parseToFloat(qtyRaw) : 1;
            const qtyToDisplay = qtyRaw !== "" ? qtyRaw : "1";
            
            const pUnit = parseToFloat(price.value) || 0;

            let itemTotal = qtyNum * pUnit;
            if (unit.value === 'g') {
                itemTotal = (qtyNum / 1000) * pUnit;
            }

            items.push({ 
                nome: text, 
                qta: qtyNum,
                qtaText: qtyToDisplay,
                unita: unit.value, 
                categoria: cat.value, 
                prezzo: pUnit,
                totaleCalcolato: itemTotal,
                preso: false 
            });

            localStorage.setItem('spesa', JSON.stringify(items));
            saveHistory(text);
            refreshUI();
            
            input.value = ""; 
            qty.value = ""; 
            price.value = ""; 
            input.focus();
        }

        function refreshUI() {
            const list = document.getElementById('shoppingList');
            list.innerHTML = "";
            const items = JSON.parse(localStorage.getItem('spesa')) || [];
            items.sort((a, b) => a.categoria.localeCompare(b.categoria));

            let totalExp = 0;
            let currentExp = 0;

            items.forEach(item => {
                totalExp += item.totaleCalcolato;
                if (item.preso) currentExp += item.totaleCalcolato;

                const li = document.createElement('li');
                if (item.preso) li.classList.add('completed');
                
                const displayQty = formatDisplay(item.qtaText || item.qta);
                const suffix = item.unita === 'g' ? '/Kg' : '';

                li.innerHTML = `
                    <div class="qty-badge">${unitEmojis[item.unita]} ${displayQty} ${item.unita}</div>
                    <div class="item-info">
                        <span class="item-text" onclick="togglePreso('${item.nome.replace(/'/g, "\\'")}')">
                            <b>${item.categoria.split(' ')[0]}</b> ${item.nome}
                        </span>
                        <span class="item-sub">Prezzo: ‚Ç¨ ${formatDisplay(item.prezzo.toFixed(2))}${suffix}</span>
                    </div>
                    <div class="price-container">
                        ${item.totaleCalcolato > 0 ? `<span class="total-price">‚Ç¨ ${formatDisplay(item.totaleCalcolato.toFixed(2))}</span>` : ''}
                    </div>
                    <div class="actions">
                        <button class="edit-btn" onclick="prepareEdit('${item.nome.replace(/'/g, "\\'")}', '${item.qtaText || item.qta}', '${item.unita}', '${item.categoria}', ${item.prezzo})">‚úçÔ∏è</button>
                        <button class="delete-btn" onclick="removeItem('${item.nome.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                    </div>`;
                list.appendChild(li);
            });

            document.getElementById('stats').textContent = `Articoli: ${items.length} (Presi: ${items.filter(i => i.preso).length})`;
            document.getElementById('total-cost').textContent = `Speso: ‚Ç¨ ${formatDisplay(currentExp.toFixed(2))} / Tot: ‚Ç¨ ${formatDisplay(totalExp.toFixed(2))}`;
            updateHistoryDatalist();
        }

        function togglePreso(nome) {
            let items = JSON.parse(localStorage.getItem('spesa'));
            const idx = items.findIndex(i => i.nome === nome);
            if(idx !== -1) {
                items[idx].preso = !items[idx].preso;
                localStorage.setItem('spesa', JSON.stringify(items));
                refreshUI();
            }
        }

        function prepareEdit(nome, qtaText, unita, cat, prezzo) {
            document.getElementById('itemInput').value = nome;
            document.getElementById('itemQty').value = qtaText;
            document.getElementById('itemUnit').value = unita;
            document.getElementById('itemCategory').value = cat;
            document.getElementById('itemPrice').value = formatDisplay(prezzo) || "";
            editMode = true;
            originalNameBeforeEdit = nome;
            document.getElementById('addBtn').textContent = "Aggiorna Prodotto";
            document.getElementById('addBtn').classList.add('edit-mode');
        }

        function removeItem(nome) {
            let items = JSON.parse(localStorage.getItem('spesa')).filter(i => i.nome !== nome);
            localStorage.setItem('spesa', JSON.stringify(items));
            refreshUI();
        }

        function saveHistory(text) {
            let history = JSON.parse(localStorage.getItem('cronologia_spesa')) || [];
            if (!history.includes(text)) {
                history.push(text);
                localStorage.setItem('cronologia_spesa', JSON.stringify(history));
            }
        }

        function updateHistoryDatalist() {
            const h = JSON.parse(localStorage.getItem('cronologia_spesa')) || [];
            document.getElementById('historyData').innerHTML = h.map(i => `<option value="${i}">`).join('');
        }

        function toggleHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
            if(modal.style.display === 'flex') renderHistoryManager();
        }

        function renderHistoryManager() {
            const h = JSON.parse(localStorage.getItem('cronologia_spesa')) || [];
            const container = document.getElementById('historyList');
            container.innerHTML = h.length === 0 ? "Cronologia vuota" : "";
            h.sort().forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<span>${item}</span><button onclick="deleteHistoryItem('${item.replace(/'/g, "\\'")}')" style="border:none; background:none; cursor:pointer">‚ùå</button>`;
                container.appendChild(div);
            });
        }

        function deleteHistoryItem(val) {
            let h = JSON.parse(localStorage.getItem('cronologia_spesa')) || [];
            h = h.filter(i => i !== val);
            localStorage.setItem('cronologia_spesa', JSON.stringify(h));
            renderHistoryManager();
            updateHistoryDatalist();
        }

        function clearList() { if (confirm("Svuotare tutta la lista?")) { localStorage.removeItem('spesa'); refreshUI(); } }

        window.onload = refreshUI;
    </script>
</body>
</html>
